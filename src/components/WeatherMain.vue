<template>
  <div class="container">
    <div class="weather-side">
      <div class="weather-gradient"></div>
      <div class="date-container">
        <h2 class="date-dayname">{{ dayDateCity.day }}</h2>
        <span class="date-day">{{ dayDateCity.date }}</span>
        <svg class="location-icon" t="1706273774654" viewBox="0 0 1024 1024" version="1.1"
          xmlns="http://www.w3.org/2000/svg" p-id="4350" width="16" height="16">
          <path
            d="M512 938.666667c-53.333333 0-384-257.258667-384-469.333334S299.925333 85.333333 512 85.333333s384 171.925333 384 384-330.666667 469.333333-384 469.333334z m0-352c64.8 0 117.333333-52.533333 117.333333-117.333334s-52.533333-117.333333-117.333333-117.333333-117.333333 52.533333-117.333333 117.333333 52.533333 117.333333 117.333333 117.333334z"
            fill="#ffffff" p-id="4351"></path>
        </svg>
        <span class="location" @click="SelectALocation">{{ dayDateCity.city }}</span>
        <div class="state">
          <transition mode="out-in">
            <p v-if="TheWeatherDataIsLoaded === 100">
              <svg t="1706878677922" class="location-icon state-icon move" viewBox="0 0 1024 1024" version="1.1"
                xmlns="http://www.w3.org/2000/svg" p-id="7239" width="16" height="16">
                <path
                  d="M393.664871 495.52477c0 11.307533-9.168824 20.466124-20.466124 20.466124l-103.671151 0c-11.307533 0-20.466124-9.15859-20.466124-20.466124 0-11.2973 9.15859-20.466124 20.466124-20.466124l103.671151 0C384.496048 475.058646 393.664871 484.22747 393.664871 495.52477z"
                  p-id="7240" fill="#ffffff"></path>
                <path
                  d="M805.207925 495.52477c0 11.307533-9.15859 20.466124-20.466124 20.466124l-103.671151 0c-11.2973 0-20.466124-9.15859-20.466124-20.466124 0-11.2973 9.168824-20.466124 20.466124-20.466124l103.671151 0C796.049335 475.058646 805.207925 484.22747 805.207925 495.52477z"
                  p-id="7241" fill="#ffffff"></path>
                <path
                  d="M547.600823 237.917668l0 103.671151c0 11.307533-9.15859 20.466124-20.466124 20.466124s-20.466124-9.15859-20.466124-20.466124l0-103.671151c0-11.307533 9.15859-20.466124 20.466124-20.466124C538.442232 217.451544 547.600823 226.610134 547.600823 237.917668z"
                  p-id="7242" fill="#ffffff"></path>
                <path
                  d="M547.600823 649.460722l0 103.681384c0 11.2973-9.15859 20.466124-20.466124 20.466124s-20.466124-9.168824-20.466124-20.466124l0-103.681384c0-11.2973 9.15859-20.466124 20.466124-20.466124C538.442232 628.994598 547.600823 638.163421 547.600823 649.460722z"
                  p-id="7243" fill="#ffffff"></path>
                <path
                  d="M411.562497 428.754041c-3.786233 6.569626-10.673084 10.233062-17.733896 10.233062-3.479241 0-6.999414-0.880043-10.222829-2.742461l-89.774653-51.861158c-9.782807-5.658883-13.129019-18.173918-7.480368-27.956725 5.658883-9.79304 18.173918-13.139252 27.956725-7.490601l89.774653 51.861158C413.864936 406.456199 417.22138 418.971234 411.562497 428.754041z"
                  p-id="7244" fill="#ffffff"></path>
                <path
                  d="M767.918647 634.633015c-3.796466 6.559393-10.673084 10.233062-17.744129 10.233062-3.469008 0-6.989181-0.890276-10.212596-2.752694l-89.774653-51.861158c-9.782807-5.64865-13.139252-18.173918-7.480368-27.956725 5.64865-9.79304 18.173918-13.139252 27.956725-7.480368l89.774653 51.861158C770.221086 612.32494 773.567297 624.850208 767.918647 634.633015z"
                  p-id="7245" fill="#ffffff"></path>
                <path
                  d="M673.723312 282.70778l-51.861158 89.76442c-3.786233 6.559393-10.673084 10.233062-17.744129 10.233062-3.469008 0-6.989181-0.890276-10.212596-2.752694-9.79304-5.64865-13.139252-18.163685-7.480368-27.956725l51.861158-89.76442c5.64865-9.79304 18.163685-13.139252 27.956725-7.490601C676.025751 260.399705 679.382195 272.91474 673.723312 282.70778z"
                  p-id="7246" fill="#ffffff"></path>
                <path
                  d="M467.854571 639.053698l-51.861158 89.774653c-3.796466 6.559393-10.673084 10.233062-17.744129 10.233062-3.479241 0-6.999414-0.890276-10.222829-2.752694-9.782807-5.658883-13.139252-18.173918-7.480368-27.956725l51.861158-89.774653c5.658883-9.782807 18.173918-13.129019 27.956725-7.480368C470.15701 616.755856 473.503221 629.27089 467.854571 639.053698z"
                  p-id="7247" fill="#ffffff"></path>
                <path
                  d="M460.435601 379.911636c-3.213181 1.862417-6.733355 2.742461-10.202363 2.742461-7.081279 0-13.957897-3.673669-17.744129-10.243295l-51.809993-89.795119c-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725 9.79304-5.64865 22.308075-2.292206 27.956725 7.500834l51.79976 89.795119C473.585085 361.747951 470.228641 374.262986 460.435601 379.911636z"
                  p-id="7248" fill="#ffffff"></path>
                <path
                  d="M666.089447 736.400816c-3.223415 1.852184-6.743588 2.742461-10.212596 2.742461-7.071046 0-13.957897-3.673669-17.744129-10.243295l-51.79976-89.805352c-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725 9.782807-5.64865 22.297842-2.281973 27.946492 7.500834l51.809993 89.805352C679.238932 718.237131 675.882488 730.752166 666.089447 736.400816z"
                  p-id="7249" fill="#ffffff"></path>
                <path
                  d="M760.499677 384.526747l-89.795119 51.809993c-3.223415 1.852184-6.743588 2.742461-10.212596 2.742461-7.071046 0-13.957897-3.673669-17.744129-10.243295-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725l89.805352-51.809993c9.782807-5.638417 22.297842-2.281973 27.946492 7.500834C773.649162 366.363062 770.292718 378.878097 760.499677 384.526747z"
                  p-id="7250" fill="#ffffff"></path>
                <path
                  d="M404.02073 590.180594l-89.805352 51.79976c-3.213181 1.862417-6.733355 2.742461-10.202363 2.742461-7.081279 0-13.957897-3.673669-17.744129-10.243295-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725l89.795119-51.79976c9.79304-5.64865 22.308075-2.292206 27.956725 7.500834S413.81377 584.531943 404.02073 590.180594z"
                  p-id="7251" fill="#ffffff"></path>
              </svg>
              正在请求当前天气
            </p>
            <p v-else-if="TheWeatherDataIsLoaded === 200">
              <svg t="1706878305307" class="location-icon state-icon" width="16" height="16" viewBox="0 0 1024 1024"
                version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6048">
                <path
                  d="M748.059855 454.547497c-22.36231-108.577904-118.169353-191.614086-236.314147-191.614086-92.64912 0-172.455747 51.129494-210.771401 127.782292-99.011015 12.724813-172.45677 92.581582-172.45677 191.614086 0 105.373932 86.241176 191.614086 191.614086 191.614086l415.132812 0c89.445148 0 159.709445-70.287833 159.709445-159.735028C894.974903 531.200294 827.914578 460.934974 748.059855 454.547497"
                  p-id="6049" fill="#ffffff"></path>
              </svg>
              {{ WeatherDataUpdatedAtATimeComputed < 1 ? '刚刚更新' : `${WeatherDataUpdatedAtATimeComputed}分钟前更新` }} </p>
                <p v-else-if="TheWeatherDataIsLoaded === 300">
                  <svg t="1706878677922" class="location-icon state-icon move" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="7239" width="16" height="16">
                    <path
                      d="M393.664871 495.52477c0 11.307533-9.168824 20.466124-20.466124 20.466124l-103.671151 0c-11.307533 0-20.466124-9.15859-20.466124-20.466124 0-11.2973 9.15859-20.466124 20.466124-20.466124l103.671151 0C384.496048 475.058646 393.664871 484.22747 393.664871 495.52477z"
                      p-id="7240" fill="#ffffff"></path>
                    <path
                      d="M805.207925 495.52477c0 11.307533-9.15859 20.466124-20.466124 20.466124l-103.671151 0c-11.2973 0-20.466124-9.15859-20.466124-20.466124 0-11.2973 9.168824-20.466124 20.466124-20.466124l103.671151 0C796.049335 475.058646 805.207925 484.22747 805.207925 495.52477z"
                      p-id="7241" fill="#ffffff"></path>
                    <path
                      d="M547.600823 237.917668l0 103.671151c0 11.307533-9.15859 20.466124-20.466124 20.466124s-20.466124-9.15859-20.466124-20.466124l0-103.671151c0-11.307533 9.15859-20.466124 20.466124-20.466124C538.442232 217.451544 547.600823 226.610134 547.600823 237.917668z"
                      p-id="7242" fill="#ffffff"></path>
                    <path
                      d="M547.600823 649.460722l0 103.681384c0 11.2973-9.15859 20.466124-20.466124 20.466124s-20.466124-9.168824-20.466124-20.466124l0-103.681384c0-11.2973 9.15859-20.466124 20.466124-20.466124C538.442232 628.994598 547.600823 638.163421 547.600823 649.460722z"
                      p-id="7243" fill="#ffffff"></path>
                    <path
                      d="M411.562497 428.754041c-3.786233 6.569626-10.673084 10.233062-17.733896 10.233062-3.479241 0-6.999414-0.880043-10.222829-2.742461l-89.774653-51.861158c-9.782807-5.658883-13.129019-18.173918-7.480368-27.956725 5.658883-9.79304 18.173918-13.139252 27.956725-7.490601l89.774653 51.861158C413.864936 406.456199 417.22138 418.971234 411.562497 428.754041z"
                      p-id="7244" fill="#ffffff"></path>
                    <path
                      d="M767.918647 634.633015c-3.796466 6.559393-10.673084 10.233062-17.744129 10.233062-3.469008 0-6.989181-0.890276-10.212596-2.752694l-89.774653-51.861158c-9.782807-5.64865-13.139252-18.173918-7.480368-27.956725 5.64865-9.79304 18.173918-13.139252 27.956725-7.480368l89.774653 51.861158C770.221086 612.32494 773.567297 624.850208 767.918647 634.633015z"
                      p-id="7245" fill="#ffffff"></path>
                    <path
                      d="M673.723312 282.70778l-51.861158 89.76442c-3.786233 6.559393-10.673084 10.233062-17.744129 10.233062-3.469008 0-6.989181-0.890276-10.212596-2.752694-9.79304-5.64865-13.139252-18.163685-7.480368-27.956725l51.861158-89.76442c5.64865-9.79304 18.163685-13.139252 27.956725-7.490601C676.025751 260.399705 679.382195 272.91474 673.723312 282.70778z"
                      p-id="7246" fill="#ffffff"></path>
                    <path
                      d="M467.854571 639.053698l-51.861158 89.774653c-3.796466 6.559393-10.673084 10.233062-17.744129 10.233062-3.479241 0-6.999414-0.890276-10.222829-2.752694-9.782807-5.658883-13.139252-18.173918-7.480368-27.956725l51.861158-89.774653c5.658883-9.782807 18.173918-13.129019 27.956725-7.480368C470.15701 616.755856 473.503221 629.27089 467.854571 639.053698z"
                      p-id="7247" fill="#ffffff"></path>
                    <path
                      d="M460.435601 379.911636c-3.213181 1.862417-6.733355 2.742461-10.202363 2.742461-7.081279 0-13.957897-3.673669-17.744129-10.243295l-51.809993-89.795119c-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725 9.79304-5.64865 22.308075-2.292206 27.956725 7.500834l51.79976 89.795119C473.585085 361.747951 470.228641 374.262986 460.435601 379.911636z"
                      p-id="7248" fill="#ffffff"></path>
                    <path
                      d="M666.089447 736.400816c-3.223415 1.852184-6.743588 2.742461-10.212596 2.742461-7.071046 0-13.957897-3.673669-17.744129-10.243295l-51.79976-89.805352c-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725 9.782807-5.64865 22.297842-2.281973 27.946492 7.500834l51.809993 89.805352C679.238932 718.237131 675.882488 730.752166 666.089447 736.400816z"
                      p-id="7249" fill="#ffffff"></path>
                    <path
                      d="M760.499677 384.526747l-89.795119 51.809993c-3.223415 1.852184-6.743588 2.742461-10.212596 2.742461-7.071046 0-13.957897-3.673669-17.744129-10.243295-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725l89.805352-51.809993c9.782807-5.638417 22.297842-2.281973 27.946492 7.500834C773.649162 366.363062 770.292718 378.878097 760.499677 384.526747z"
                      p-id="7250" fill="#ffffff"></path>
                    <path
                      d="M404.02073 590.180594l-89.805352 51.79976c-3.213181 1.862417-6.733355 2.742461-10.202363 2.742461-7.081279 0-13.957897-3.673669-17.744129-10.243295-5.64865-9.79304-2.292206-22.308075 7.500834-27.956725l89.795119-51.79976c9.79304-5.64865 22.308075-2.292206 27.956725 7.500834S413.81377 584.531943 404.02073 590.180594z"
                      p-id="7251" fill="#ffffff"></path>
                  </svg>
                  请求失败, 第 {{ errCount }} 次重试中
                </p>
                <p v-else-if="TheWeatherDataIsLoaded === 400">
                  <svg t="1706881519739" class="location-icon state-icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="10246" width="16" height="16">
                    <path
                      d="M512 17.066667C238.933333 17.066667 17.066667 238.933333 17.066667 512s221.866667 494.933333 494.933333 494.933333 494.933333-221.866667 494.933333-494.933333S785.066667 17.066667 512 17.066667z m-110.933333 273.066666h32.426666v63.146667h-32.426666V290.133333z m-56.32 23.893334l44.373333 44.373333-22.186667 22.186667-44.373333-44.373334 22.186667-22.186666z m-47.786667 80.213333h63.146667V426.666667h-63.146667v-32.426667zM477.866667 721.92c-49.493333 49.493333-128 49.493333-177.493334 0-49.493333-49.493333-49.493333-128 0-177.493333l88.746667-88.746667 32.426667 32.426667-88.746667 88.746666c-30.72 30.72-30.72 80.213333 0 110.933334 30.72 30.72 80.213333 30.72 110.933333 0l88.746667-88.746667 32.426667 32.426667-87.04 90.453333z m145.066666-1.706667h-32.426666v-63.146666h32.426666v63.146666z m56.32-23.893333l-44.373333-44.373333 22.186667-22.186667 44.373333 44.373333-22.186667 22.186667z m47.786667-80.213333h-63.146667v-32.426667h63.146667v32.426667z m-5.12-138.24l-88.746667 88.746666-32.426666-32.426666 88.746666-88.746667c30.72-30.72 30.72-80.213333 0-110.933333-30.72-30.72-80.213333-30.72-110.933333 0l-88.746667 88.746666-32.426666-32.426666 88.746666-88.746667c49.493333-49.493333 128-49.493333 177.493334 0 47.786667 47.786667 47.786667 128-1.706667 175.786667z"
                      p-id="10247" fill="#ffffff"></path>
                  </svg>
                  已离线, 等待网络连接
                </p>
                <p v-else-if="TheWeatherDataIsLoaded === 0">
                  <svg t="1706881699845" class="location-icon state-icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="13362" width="16" height="16">
                    <path
                      d="M536.856619 117.127627c-202.173582 0-366.066303 163.896814-366.066303 366.06835 0 202.173582 163.892721 366.066303 366.066303 366.066303 202.171536 0 366.06835-163.892721 366.06835-366.066303 0-202.171536-163.896814-366.06835-366.06835-366.06835z m-43.290969 189.153035c0-23.909549 19.381419-43.290969 43.290969-43.290969s43.291992 19.381419 43.291992 43.290969v198.920492c0 23.908526-19.381419 43.290969-43.291992 43.290968-23.908526 0-43.290969-19.381419-43.290969-43.290968v-198.920492z m43.74634 384.962675c-24.160259 0-43.74634-19.586081-43.74634-43.74634s19.586081-43.74634 43.74634-43.74634 43.74634 19.586081 43.74634 43.74634-19.585057 43.74634-43.74634 43.74634z"
                      fill="#ffffff" p-id="13363"></path>
                  </svg>
                  接口出错了, 尝试重新应用壁纸, 或联系开发者修复
                </p>
                <p v-else>
                  <svg t="1706881699845" class="location-icon state-icon" viewBox="0 0 1024 1024" version="1.1"
                    xmlns="http://www.w3.org/2000/svg" p-id="13362" width="16" height="16">
                    <path
                      d="M536.856619 117.127627c-202.173582 0-366.066303 163.896814-366.066303 366.06835 0 202.173582 163.892721 366.066303 366.066303 366.066303 202.171536 0 366.06835-163.892721 366.06835-366.066303 0-202.171536-163.896814-366.06835-366.06835-366.06835z m-43.290969 189.153035c0-23.909549 19.381419-43.290969 43.290969-43.290969s43.291992 19.381419 43.291992 43.290969v198.920492c0 23.908526-19.381419 43.290969-43.291992 43.290968-23.908526 0-43.290969-19.381419-43.290969-43.290968v-198.920492z m43.74634 384.962675c-24.160259 0-43.74634-19.586081-43.74634-43.74634s19.586081-43.74634 43.74634-43.74634 43.74634 19.586081 43.74634 43.74634-19.585057 43.74634-43.74634 43.74634z"
                      fill="#ffffff" p-id="13363"></path>
                  </svg>
                  发生未知错误, 尝试重新应用壁纸, 或联系开发者修复
                </p>
          </transition>
        </div>
        <div  class="EarlyWarning"  v-if="WeatherEarlyWarning.length !== 0" @click="EarlyWarningDetailsDialog = true">
          <svg class="icon" aria-hidden="true">
            <use :xlink:href="WeatherEarlyWarningLevel(WeatherEarlyWarning[0].level)"></use>
          </svg>
          {{WeatherEarlyWarning[0].typeName}}{{WeatherEarlyWarning[0].level}}预警
        </div>
      </div>
      <div class="weather-container">
        <i :class="`qi-${nowWeatherData.icon} weather-icon`"></i>
        <h1 class="weather-temp">{{ nowWeatherData.temp }}°C</h1>
        <h3 class="weather-desc">{{ nowWeatherData.text }}</h3>
      </div>
    </div>
    <div class="info-side">
      <div class="today-info-container">
        <div class="today-info">
          <div class="precipitation"> <span class="title">降雨量</span><span class="value">{{ activeWeatherDate[0]?.precip
              }}
              mm</span>
          </div>
          <div class="humidity"> <span class="title">湿度</span><span class="value">{{ activeWeatherDate[0]?.humidity }}
              %</span>
          </div>
          <div class="wind"> <span class="title">风速</span><span class="value">{{ activeWeatherDate[0]?.windSpeedDay }}
              km/h</span>
          </div>
        </div>
      </div>
      <div class="week-container">
        <ul class="week-list">
          <li v-for="item in FourDayWeatherData" :key="item.fxDate" :class="{ active: activeItem === item.fxDate }"
            @click="activeItem = item.fxDate ">
            <i :class="`qi-${item.iconDay} day-icon`"></i>
            <span class="day-name">{{ item.fxDate }}</span>
            <span class="day-temp">{{ `${item.tempMax}/${item.tempMin}` }}°C</span>
          </li>
        </ul>
      </div>
    </div>
</div>
  <SelectLocationDialog ref="SearchLocationDialogRef"></SelectLocationDialog>
</template>

<script setup>
import 'qweather-icons/font/qweather-icons.css'
import { onMounted, ref, computed, onUnmounted } from 'vue';
import { storeToRefs } from 'pinia';
import { useWeatherStore } from '@/store/index';
import SelectLocationDialog from './SelectLocationDialog.vue';
const weatherStore = useWeatherStore()
const SearchLocationDialogRef = ref(null)
const { dayDateCity, FourDayWeatherData, nowWeatherData, WeatherDataUpdatedAtATimeComputed, TheWeatherDataIsLoaded, WeatherEarlyWarning ,EarlyWarningDetailsDialog} = storeToRefs(weatherStore)
const { getLocationInformation, getFourDayWeatherData, getRealTimeWeather, ReviseState, getWeatherEarlyWarning } = weatherStore
const activeItem = ref('今天')
const activeWeatherDate = computed(() => FourDayWeatherData.value.filter(item => item.fxDate === activeItem.value))
const WeatherEarlyWarningLevel = (event) => {
  if (event === '蓝色') return '#icon-tianqiyujing-lan'
  else if (event === '黄色') return '#icon-tianqiyujing-huang'
  else if (event === '橙色') return '#icon-tianqiyujing-cheng'
  else if (event === '红色') return '#icon-tianqi-yujing'
}
let timer = null
let errCount = ref(0)

const updateWeather = async () => {
  clearTimeout(timer)
  if (!window.navigator.onLine) {
    ReviseState(400)
    window.addEventListener('online', updateWeather)
    return
  }
  window.removeEventListener('online', updateWeather)
  try {
    await Promise.all([getLocationInformation(), getFourDayWeatherData(), getRealTimeWeather(), getWeatherEarlyWarning()])
    // 请求成功
    timer = setTimeout(() => {
      activeItem.value = FourDayWeatherData.value[0].fxDate
      ReviseState(200)
      errCount.value = 0
      timer = setTimeout(updateWeather, 1000 * 60)
    }, 1000)
  }
  catch (error) {
    console.error(error);
    errCount.value++
    if (errCount.value > 5) {
      // 失败次数超过5次，下一次请求将在30秒之后
      ReviseState(0)
      timer = setTimeout(updateWeather, 1000 * 30)
      return
    }
    ReviseState(300)
    // 请求失败，五秒后重试
    timer = setTimeout(updateWeather, 1000 * 5)
  }
}

const SelectALocation = () => {
  SearchLocationDialogRef.value.showDialog()
}

onMounted(() => {
  updateWeather()
})
onUnmounted(() => {
  clearTimeout(timer)
})
</script>

<style lang="scss">
// @import url(../style/iconfont.css);
/* 下面我们会解释这些 class 是做什么的 */
.v-enter-active,
.v-leave-active {
  transition: all 0.3s ease;
}

.v-enter-from,
.v-leave-to {
  opacity: 0;
  transform: translateY(-0.8vw);
}

.state {
  height: 2.5vw;
}
.location {
  cursor: pointer;
}
.EarlyWarning {
  background-color: #ffffff40;
  padding: 0.2vw 0.8vw;
  min-width: 20vw;
  max-width: 25vw;
  height: 2.5vw;
  overflow: hidden;
  transition: all 300ms;
  border-radius: 0.5vw;
  cursor: pointer;
  font-size: 1vw;
  display: flex;
  // justify-content: center;
  align-items: center;

  // color: #e7aa02;
  &:hover {
    background-color: #ffffff50;
  }

  .icon {
    width: 1em;
    height: 1em;
    vertical-align: -0.15em;
    fill: currentColor;
    overflow: hidden;
    margin-right: 0.5vw;
  }
}

p {
  display: block;
  display: flex;
  align-items: center;
  margin: 1vw 0;
  padding: 0;
  font-size: 0.7em;

  .state-icon {
    width: 1.2em !important;
    height: 1.2em !important;
    margin-right: 0.5vw !important;

    &.move {
      height: 10vw;
      animation: loadMove 1.5s linear infinite;
      width: 1.3em !important;
      height: 1.3em !important;

      @keyframes loadMove {
        to {
          transform: rotate(360deg);
        }
      }
    }
  }

}
</style>